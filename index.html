<html>
<head>
    <title>Anderson Luis Mendonça</title>
    <meta charset="UTF-8">
    <style>
        #recebido {
            color: #007aff;
            font-weight: bold;
            font-family: monospace;
            background-color: #f4f4f4;
            padding: 2px 5px;
            border-radius: 4px;
        }
        #envio-container {
            margin: 20px 0;
        }
        #mensagemInput {
            padding: 4px 8px;
            font-size: 1em;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-right: 8px;
            width: 250px;
            box-sizing: border-box;
        }
        #botaoEnviar {
            padding: 4px 16px;
            font-size: 1em;
            border-radius: 4px;
            color: #fff;
            background-color: #007aff;
            border: none;
            cursor: pointer;
        }
        #botaoEnviar:hover {
            background-color: #005fa3;
        }
    </style>
</head>
<body>
    <h1>Comunicação Delphi - Browser</h1>
    
    <div id="envio-container">
        <!-- Input para digitar a mensagem -->
        <input type="text" id="mensagemInput" placeholder="Digite a mensagem para o Delphi" />
        <button id="botaoEnviar" onclick="enviarMensagem()">Enviar</button>
    </div>
    
    <hr>
    <h2>Dados Recebidos do Delphi:</h2>
    <p>
        O Delphi enviou: <span id="recebido">(Aguardando dados...)</span>
    </p>

    <script>
        /**
         * FUNÇÃO RECEPTORA (Chamada pelo Delphi)
         * Recebe dados DO Delphi e exibe na tela.
         */
        window.carregarDadosDoDelphi = function(jsonString) {
            try {
                console.log("Dados recebidos do Delphi:", jsonString);
                const elRecebido = document.getElementById('recebido');

                if (elRecebido) {
                    // Preenche o <span> com a string recebida
                    elRecebido.textContent = jsonString;
                }
            } catch (e) {
                console.error("Falha ao processar JSON do Delphi:", e, jsonString);
                alert("Erro ao receber dados do Delphi.");
            }
        };

        /**
         * FUNÇÃO EMISSORA (Chamada pelo HTML)
         * Envia dados PARA o Delphi.
         */
        function postarMensagemParaDelphi(mensagem) {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage(mensagem);
                console.log('Mensagem enviada:', mensagem);
            } else {
                const erro = 'Erro: A aplicação não está rodando dentro do host WebView2 (Delphi).';
                console.error(erro);
            }
        }

        /** Nova função: envia a mensagem do input */
        function enviarMensagem() {
            const input = document.getElementById('mensagemInput');
            const mensagem = input.value.trim();
            if (mensagem.length === 0) {
                alert('Digite uma mensagem para enviar ao Delphi.');
                input.focus();
                return;
            }
            postarMensagemParaDelphi(mensagem);
            input.value = '';
            input.focus();
        }

        // Pressionando ENTER no input também envia
        document.getElementById('mensagemInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                enviarMensagem();
            }
        });
    </script>
</body>
</html>
